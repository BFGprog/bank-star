-- recommendation 1
SELECT DISTINCT user_id FROM TRANSACTIONs T
INNER JOIN PRODUCTS P ON T.product_id = P.id
WHERE P.TYPE = 'DEBIT'
AND user_id <> ALL (SELECT USER_id FROM(SELECT T.USER_ID FROM TRANSACTIONS t
INNER JOIN PRODUCTS P ON t.product_id = P.id WHERE p.TYPE = 'INVEST'))
AND T.USER_ID <> ALL (SELECT T.USER_ID FROM TRANSACTIONS t
INNER JOIN PRODUCTS P ON t.product_id = P.id WHERE  t.AMOUNT < 1000 AND P.TYPE = 'SAVING')

-- recommendation 2
WITH wit AS
(SELECT user_id, sum(amount) AS sum_wit, type FROM TRANSACTIONS
WHERE PRODUCT_ID IN (SELECT id FROM PRODUCTS WHERE TYPE = 'DEBIT') AND TYPE = 'WITHDRAW'
GROUP BY USER_ID ),
dep AS
(SELECT user_id, sum(amount) AS sum_dep, type FROM TRANSACTIONS
WHERE PRODUCT_ID IN (SELECT id FROM PRODUCTS WHERE TYPE = 'DEBIT') AND TYPE = 'DEPOSIT'
GROUP BY USER_ID)

SELECT DISTINCT t.USER_ID FROM TRANSACTIONs T
INNER JOIN PRODUCTS P ON T.product_id = P.id
WHERE P.TYPE = 'DEBIT'
AND T.USER_ID <> ALL (SELECT USER_ID FROM (
SELECT t.USER_ID ,p.TYPE , sum(t.AMOUNT) AS sum_amount FROM TRANSACTIONs T
INNER JOIN PRODUCTS P ON T.product_id = P.id
WHERE (P.TYPE = 'DEBIT' OR P.TYPE = 'SAVING') AND t.TYPE = 'DEPOSIT'
GROUP BY t.USER_ID, p.TYPE
HAVING sum_amount <= 50000))
AND USER_ID IN (
SELECT USER_ID FROM(SELECT TRANSACTIONS.user_id, wit.sum_wit, dep.sum_dep FROM TRANSACTIONS
left JOIN wit ON wit.user_id = TRANSACTIONS.user_id
left JOIN dep ON dep.user_id = TRANSACTIONS.user_id
WHERE wit.sum_wit IS NOT NULL OR dep.sum_dep IS NOT null
GROUP BY TRANSACTIONS.USER_ID
HAVING wit.sum_wit < dep.sum_dep))

-- recommendation 3
WITH wit AS
(SELECT user_id, sum(amount) AS sum_wit, type FROM TRANSACTIONS
WHERE PRODUCT_ID IN (SELECT id FROM PRODUCTS WHERE TYPE = 'DEBIT') AND TYPE = 'WITHDRAW'
GROUP BY USER_ID ),
dep AS
(SELECT user_id, sum(amount) AS sum_dep, type FROM TRANSACTIONS
WHERE PRODUCT_ID IN (SELECT id FROM PRODUCTS WHERE TYPE = 'DEBIT') AND TYPE = 'DEPOSIT'
GROUP BY USER_ID)

SELECT USER_ID FROM(SELECT TRANSACTIONS.user_id, wit.sum_wit, dep.sum_dep FROM TRANSACTIONS
left JOIN wit ON wit.user_id = TRANSACTIONS.user_id
left JOIN dep ON dep.user_id = TRANSACTIONS.user_id
WHERE wit.sum_wit IS NOT NULL OR dep.sum_dep IS NOT NULL
AND TRANSACTIONS.PRODUCT_ID <> ALL (SELECT id FROM PRODUCTS WHERE TYPE = 'CREDIT')
GROUP BY TRANSACTIONS.USER_ID
HAVING wit.sum_wit < dep.sum_dep and wit.sum_wit > 100000)